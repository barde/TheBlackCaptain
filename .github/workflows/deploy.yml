name: Deploy to Cloudflare Pages

on:
  # Only deploy when PR is merged to master (not on direct push)
  pull_request:
    types: [closed]
    branches:
      - master
  # Allow manual deployment
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to blackhoard.com
    # Only run if PR was merged (not just closed)
    if: github.event_name == 'workflow_dispatch' || (github.event.pull_request.merged == true)

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install

      - name: Build site
        run: pnpm run build

      - name: Strip EXIF data from images
        run: |
          echo "ðŸ”’ Removing EXIF metadata from images for privacy..."
          sudo apt-get update && sudo apt-get install -y libimage-exiftool-perl
          find public -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.gif" -o -iname "*.webp" \) -exec exiftool -all= -overwrite_original {} \; 2>/dev/null || true
          find images -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.gif" -o -iname "*.webp" \) -exec exiftool -all= -overwrite_original {} \; 2>/dev/null || true
          echo "âœ“ EXIF data removed"

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy public --project-name=the-black-captain --branch=master --commit-dirty=true

      - name: Wait for deployment
        run: sleep 10

      - name: Install Playwright browsers
        run: pnpm exec playwright install chromium --with-deps

      - name: Test deployment
        run: pnpm run test:deployment
        continue-on-error: true

      - name: Test translation
        run: pnpm run test:translation
        env:
          TEST_URL: https://blackhoard.com
        continue-on-error: true

      - name: Upload test screenshot
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-screenshot
          path: deployment-test-screenshot.png
          if-no-files-found: ignore

      - name: Post deployment summary
        run: |
          echo "## ðŸ´â€â˜ ï¸ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Production URL:** https://blackhoard.com" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed from PR:** #${{ github.event.pull_request.number }} - ${{ github.event.pull_request.title }}" >> $GITHUB_STEP_SUMMARY
