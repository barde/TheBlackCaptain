name: Deploy to Cloudflare Pages

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to blackhoard.com

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install

      - name: Build site
        run: pnpm run build

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy public --project-name=the-black-captain --branch=master --commit-dirty=true

      - name: Add custom domain (if needed)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          # Add custom domain via API
          DOMAIN="blackhoard.com"
          PROJECT_NAME="the-black-captain"
          ACCOUNT_ID="${CLOUDFLARE_ACCOUNT_ID}"
          API_TOKEN="${CLOUDFLARE_API_TOKEN}"
          PAGES_TARGET="the-black-captain.pages.dev"

          echo "üåê Checking/Adding custom domain..."

          # Get Zone ID
          ZONE_RESPONSE=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones?name=$DOMAIN" \
            -H "Authorization: Bearer $API_TOKEN" \
            -H "Content-Type: application/json")

          ZONE_ID=$(echo "$ZONE_RESPONSE" | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4)

          if [ -z "$ZONE_ID" ]; then
            echo "‚ùå Could not find zone for $DOMAIN"
            exit 0  # Don't fail the build
          fi

          echo "‚úì Zone ID: $ZONE_ID"

          # Add/Update CNAME DNS Record
          echo "Adding CNAME record..."
          DNS_RESPONSE=$(curl -s -X POST "https://api.cloudflare.com/client/v4/zones/$ZONE_ID/dns_records" \
            -H "Authorization: Bearer $API_TOKEN" \
            -H "Content-Type: application/json" \
            --data "{\"type\":\"CNAME\",\"name\":\"@\",\"content\":\"$PAGES_TARGET\",\"ttl\":1,\"proxied\":true}")

          if echo "$DNS_RESPONSE" | grep -q '"success":true'; then
            echo "‚úì CNAME record created"
          elif echo "$DNS_RESPONSE" | grep -q "already exists"; then
            echo "‚úì CNAME already exists"
          else
            echo "‚ö† DNS record response: $DNS_RESPONSE"
          fi

          # Add Custom Domain to Pages
          echo "Adding custom domain to Pages..."
          PAGES_RESPONSE=$(curl -s -X POST "https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/pages/projects/$PROJECT_NAME/domains" \
            -H "Authorization: Bearer $API_TOKEN" \
            -H "Content-Type: application/json" \
            --data "{\"name\":\"$DOMAIN\"}")

          if echo "$PAGES_RESPONSE" | grep -q '"success":true'; then
            echo "‚úì Custom domain added"
          elif echo "$PAGES_RESPONSE" | grep -q "already exists"; then
            echo "‚úì Domain already configured"
          else
            echo "‚ö† Pages response: $PAGES_RESPONSE"
          fi

          echo "‚úÖ Domain setup complete!"

      - name: Wait for DNS propagation
        run: sleep 10

      - name: Install Playwright browsers
        run: pnpm exec playwright install chromium --with-deps

      - name: Test deployment
        run: pnpm run test:deployment
        continue-on-error: true

      - name: Upload test screenshot
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-screenshot
          path: deployment-test-screenshot.png
          if-no-files-found: ignore

