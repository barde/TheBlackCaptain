name: PR Preview & Validation

on:
  pull_request:
    branches:
      - master

permissions:
  contents: read
  pull-requests: write

jobs:
  build-and-preview:
    runs-on: ubuntu-latest
    name: Build & Preview

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install

      - name: Build site
        run: pnpm run build

      - name: Check for broken internal links
        run: pnpm run check:links
        continue-on-error: true

      - name: Deploy preview to Cloudflare Pages
        id: preview
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy public --project-name=the-black-captain --branch=${{ github.head_ref }} --commit-dirty=true

      - name: Install Playwright browsers
        run: pnpm exec playwright install chromium --with-deps

      - name: Test translation on preview
        run: pnpm run test:translation
        env:
          TEST_URL: ${{ steps.preview.outputs.deployment-url }}
        continue-on-error: true

      - name: Comment preview URL on PR
        uses: actions/github-script@v7
        with:
          script: |
            const previewUrl = '${{ steps.preview.outputs.deployment-url }}';
            const branch = context.payload.pull_request.head.ref;

            // Check if we already commented
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const botComment = comments.data.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Preview deployment')
            );

            const body = `## ðŸ”­ Preview deployment

            | Environment | URL |
            |-------------|-----|
            | Preview | ${previewUrl} |
            | Production | https://blackhoard.com |

            This preview will be updated with each new commit to this PR.

            ---
            *Preview deployed from commit ${context.sha.substring(0, 7)}*`;

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Post build summary
        run: |
          echo "## ðŸ—ï¸ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.head_ref }}" >> $GITHUB_STEP_SUMMARY
          echo "**Preview URL:** ${{ steps.preview.outputs.deployment-url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Built Files" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          find public -name "*.html" | wc -l | xargs -I {} echo "{} HTML pages"
          find public -name "*.html" | wc -l >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
